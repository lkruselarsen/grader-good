#!/usr/bin/env node

/**
 * Dev helper to refresh src/config/learnedHeuristics.ts from the
 * /api/corrections/learn endpoint.
 *
 * Usage (from project root):
 *   - Ensure your Next dev server is running (npm run dev).
 *   - Run: npm run learn:heuristics
 *
 * You can override the base URL with LEARN_BASE_URL, e.g.:
 *   LEARN_BASE_URL="https://your-app.vercel.app" npm run learn:heuristics
 */

import fs from "node:fs/promises";
import path from "node:path";
import { fileURLToPath } from "node:url";
import http from "node:http";
import https from "node:https";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const projectRoot = path.resolve(__dirname, "..");

const base =
  process.env.LEARN_BASE_URL?.replace(/\/$/, "") ?? "http://localhost:3000";
const learnUrl = `${base}/api/corrections/learn`;

const targetPath = path.join(
  projectRoot,
  "src",
  "config",
  "learnedHeuristics.ts"
);

function fetchJson(url) {
  return new Promise((resolve, reject) => {
    const client = url.startsWith("https:") ? https : http;
    const req = client.get(url, (res) => {
      if (res.statusCode && res.statusCode >= 400) {
        reject(
          new Error(`Request failed with status ${res.statusCode} ${res.statusMessage ?? ""}`)
        );
        res.resume();
        return;
      }
      let data = "";
      res.setEncoding("utf8");
      res.on("data", (chunk) => {
        data += chunk;
      });
      res.on("end", () => {
        try {
          const json = JSON.parse(data);
          resolve(json);
        } catch (err) {
          reject(
            new Error(
              `Failed to parse JSON from ${url}: ${
                err instanceof Error ? err.message : String(err)
              }`
            )
          );
        }
      });
    });
    req.on("error", (err) => reject(err));
  });
}

async function main() {
  console.log(`Fetching heuristics from ${learnUrl} ...`);
  const json = await fetchJson(learnUrl);

  if (!json || typeof json !== "object") {
    throw new Error("Learn endpoint did not return a JSON object.");
  }

  const heuristics = json.heuristics;
  if (!heuristics || typeof heuristics !== "object") {
    throw new Error(
      "Learn endpoint response does not contain a valid `heuristics` object."
    );
  }

  const header = `import type { LearnedHeuristics } from "@/src/lib/pipeline/heuristicsBuckets";

/**
 * Snapshot of learned parameter deltas from grading corrections.
 *
 * AUTO-GENERATED by scripts/update-heuristics.mjs
 * Source: ${learnUrl}
 * Generated at: ${new Date().toISOString()}
 *
 * Do not edit this file by hand; instead, run:
 *   npm run learn:heuristics
 */

export const LEARNED_HEURISTICS: LearnedHeuristics | null = `;

  const body = JSON.stringify(heuristics, null, 2);
  const content = `${header}${body} as LearnedHeuristics;
`;

  await fs.writeFile(targetPath, content, "utf8");
  console.log(`Wrote heuristics snapshot to ${path.relative(projectRoot, targetPath)}.`);
}

main().catch((err) => {
  console.error("Failed to update learned heuristics:");
  console.error(err instanceof Error ? err.stack ?? err.message : String(err));
  process.exitCode = 1;
});

